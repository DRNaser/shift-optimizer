# SOLVEREIGN V3.3b Backlog

**Created**: 2026-01-05
**Baseline**: v3.3a-full-approval (a8005c2)
**Security Architecture**: [SECURITY_ARCHITECTURE_V3.3b.md](SECURITY_ARCHITECTURE_V3.3b.md)

---

## Priority 0: Security Foundation (MUST before other features)

### P0.1 Authentication Layer
- [ ] Keycloak/Auth0 tenant setup
- [x] JWT validation middleware (RS256) → `api/security/jwt.py`
- [x] Token refresh with rotation → `api/security/token_refresh.py`
- [x] Token blacklist (Redis) → `api/security/token_blacklist.py`
- [ ] MFA enforcement for PLAN_APPROVER+
- [x] Security headers middleware → `api/security/headers.py`

### P0.2 Authorization Layer (RBAC)
- [x] Role hierarchy: VIEWER → DISPATCHER → PLAN_APPROVER → TENANT_ADMIN → `api/security/rbac.py`
- [x] Permission matrix implementation → `api/security/rbac.py` (20+ permissions)
- [x] `PermissionChecker` dependency → `api/security/rbac.py`
- [x] Cross-tenant prevention (even with valid token) → `api/security/rbac.py`
- [x] Admin action audit → `api/security/audit.py`

### P0.3 Data Protection
- [x] RLS policies on all tables → `db/migrations/010_security_layer.sql`
- [ ] RLS bypass prevention (dangerous SQL detection)
- [x] PII encryption module (AES-256-GCM + AAD) → `api/security/encryption.py`
- [x] Key rotation procedure (24h overlap) → `api/security/encryption.py`
- [x] GDPR auto-deletion cron job → `api/security/encryption.py`

### P0.4 Security Audit
- [x] `security_audit_log` table with hash chain → `db/migrations/010_security_layer.sql`
- [x] Immutable triggers (no UPDATE/DELETE) → `db/migrations/010_security_layer.sql`
- [ ] CRITICAL event alerting
- [x] Rate limiting (per-tenant, per-user, per-IP) → `api/security/rate_limit.py`
- [ ] Penetration test (before production)

---

## Priority 1: Driver Model

### P1.1 Schema
- [ ] `drivers` table (encrypted PII)
- [ ] Qualifications (ADR, Kühlfahrzeug, etc.)
- [ ] Max weekly hours per driver
- [ ] Consent tracking (GDPR)

### P1.2 API
- [ ] CRUD endpoints (tenant-scoped)
- [ ] Bulk import (CSV)
- [ ] Access logging for PII reads
- [ ] Export with audit trail

### P1.3 Availability
- [ ] `driver_availability` table
- [ ] Weekly availability patterns
- [ ] Exception dates (vacation, sick)
- [ ] Preference weights (soft constraints)

---

## Priority 2: Real-Time Operations

### P2.1 Live Re-Plan
- [ ] Partial re-optimization (frozen tours preserved)
- [ ] Driver absence handling
- [ ] Tour cancellation handling
- [ ] Churn minimization objective

### P2.2 Notifications
- [ ] WebSocket authentication (same JWT)
- [ ] Plan update push
- [ ] Driver notification queue
- [ ] SMS/WhatsApp integration (Twilio)

---

## Priority 3: Analytics

### P3.1 Historical Data
- [ ] TimescaleDB for KPI time series
- [ ] Weekly rollup jobs
- [ ] Retention policy (2 years)

### P3.2 Dashboards
- [ ] Grafana integration
- [ ] Cost curve visualization
- [ ] Tenant comparison (anonymized)

### P3.3 What-If Simulator
- [ ] UI for scenario selection
- [ ] Side-by-side comparison
- [ ] Export simulation results

---

## Security Blindspots Addressed

| Blindspot | Section | Mitigation |
|-----------|---------|------------|
| Token leakage via Referrer | P0.1 | `Referrer-Policy: no-referrer` |
| Token in localStorage | P0.1 | HttpOnly cookies only |
| Permission escalation | P0.2 | `PermissionChecker` with audit |
| Cross-tenant via API | P0.2 | Double-check even with valid token |
| RLS bypass via SQL | P0.3 | Dangerous SQL pattern detection |
| PII copying between tenants | P0.3 | AAD binds ciphertext to tenant+driver |
| Audit log tampering | P0.4 | Hash chain + immutable triggers |
| Brute force | P0.4 | Rate limit 10 req/min on `/auth/login` |
| Data exfiltration | P0.4 | Rate limit 5 req/hour on `/export/*` |

---

## Implementation Order

```
Week 1-2: P0.1 Authentication
Week 2-3: P0.2 Authorization
Week 3-4: P0.3 Data Protection + P0.4 Audit
Week 4:   Security Review + Pen Test
Week 5-6: P1 Driver Model
Week 7-8: P2 Real-Time
Week 9+:  P3 Analytics
```

---

## Exit Criteria for V3.3b

- [ ] All P0 items complete
- [ ] Penetration test passed (no CRITICAL/HIGH findings)
- [ ] GDPR DPA review approved
- [ ] Security architecture document signed off
- [ ] At least P1.1 (Driver schema) complete

---

*Last Updated: 2026-01-05 (P0 Implementation Phase)*

---

## Implementation Progress

### Files Created (V3.3b Security Layer)

| File | Lines | Description |
|------|-------|-------------|
| `api/security/__init__.py` | 57 | Module exports |
| `api/security/jwt.py` | ~280 | JWT validation with RS256/JWKS |
| `api/security/rbac.py` | ~350 | RBAC with 20+ permissions |
| `api/security/headers.py` | ~120 | Security headers middleware |
| `api/security/rate_limit.py` | ~300 | Multi-level rate limiting |
| `api/security/audit.py` | ~400 | Security audit with hash chain |
| `api/security/token_blacklist.py` | ~280 | Token revocation (Redis) |
| `api/security/token_refresh.py` | ~350 | Token refresh with rotation |
| `api/security/encryption.py` | ~400 | PII encryption (AES-256-GCM) |
| `db/migrations/010_security_layer.sql` | ~365 | RLS policies, audit table |

**Total**: ~2,900 lines of security code
