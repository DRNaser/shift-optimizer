name: A/B Experiment Workflow

on:
  workflow_dispatch:
    inputs:
      baseline_ref:
        description: 'Baseline ref (tag/branch/sha)'
        required: false
        default: 'v7.0.0-freeze'
      candidate_ref:
        description: 'Candidate ref (tag/branch/sha)'
        required: false
        default: 'main'
      seeds:
        description: 'Seeds to test (format: 0-9 or 0,1,2)'
        required: false
        default: '0-9'
      time_budget:
        description: 'Time budget per seed (seconds)'
        required: false
        default: '120'

env:
  PYTHON_VERSION: "3.11"
  PYTHONHASHSEED: "0"

jobs:
  ab-experiment:
    name: A/B Test (${{ inputs.baseline_ref }} vs ${{ inputs.candidate_ref }})
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.candidate_ref }}
          fetch-depth: 0  # Full history for git worktree
      
      - name: Fetch all tags and branches
        run: |
          git fetch --tags --force
          git fetch --all
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend_py/requirements.txt
          
          # Install additional tools for hashing if available
          pip install blake3 || echo "blake3 not available, using sha256"
      
      - name: Prepare test fixture
        run: |
          cp backend_py/tests/fixtures/forecast_ci_test.csv "forecast input.csv"
      
      - name: Run A/B Comparison
        run: |
          python backend_py/experiment_tracking.py \
            --baseline-ref "${{ inputs.baseline_ref }}" \
            --candidate-ref "${{ inputs.candidate_ref }}" \
            --seeds "${{ inputs.seeds }}" \
            --time-budget ${{ inputs.time_budget }} \
            --out artifacts/ab_report.json
        env:
          PYTHONHASHSEED: 0
      
      - name: Validate Promotion Gates
        id: gate_validation
        run: |
          python backend_py/validate_promotion_gates.py artifacts/ab_report.json
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "result=PASS" >> $GITHUB_OUTPUT
            echo "✅ All promotion gates PASSED"
          else
            echo "result=FAIL" >> $GITHUB_OUTPUT
            echo "❌ Promotion gates FAILED"
          fi
          
          exit $exit_code
        continue-on-error: true
      
      - name: Generate Summary Report
        if: always()
        run: |
          echo "# A/B Experiment Results" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Baseline**: \`${{ inputs.baseline_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Candidate**: \`${{ inputs.candidate_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Seeds**: \`${{ inputs.seeds }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Time Budget**: \`${{ inputs.time_budget }}s\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.gate_validation.outputs.result }}" = "PASS" ]; then
            echo "## ✅ Promotion Gates: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Candidate is approved for promotion!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Promotion Gates: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Candidate does not meet promotion criteria." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
      
      - name: Upload A/B Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ab-experiment-${{ github.run_number }}
          path: |
            artifacts/ab_report.json
            .worktrees/*/backend_py/roster_matrix.csv
          retention-days: 90
      
      - name: Fail if gates failed
        if: steps.gate_validation.outputs.result == 'FAIL'
        run: |
          echo "❌ Experiment failed promotion gates"
          exit 1
