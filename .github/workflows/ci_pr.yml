name: CI - PR & Push Gate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger for testing

env:
  PYTHON_VERSION: "3.12"
  PYTHONHASHSEED: "0"

jobs:
  quality-gate:
    name: Quality Gate (Fast)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend_py/requirements.txt
      
      - name: Prepare test fixture
        run: |
          cp backend_py/tests/fixtures/forecast_ci_test.csv "forecast input.csv"
      
      - name: Verify fixture is used (not production data)
        run: |
          lines=$(wc -l < "forecast input.csv")
          echo "Forecast input: $lines lines"
          
          # CI fixture should be ~100 lines, production is ~300+
          if [ "$lines" -gt 150 ]; then
            echo "⚠️ WARNING: Forecast looks like production data (${lines} lines)"
            echo "Expected: CI fixture (~100 lines)"
            exit 1
          fi
          
          echo "✅ Using CI test fixture (${lines} lines)"
      
      - name: Run Quality Gate (Seed 42, 60s budget)
        run: |
          python backend_py/export_roster_matrix.py \
            --time-budget 60 \
            --seed 42
        env:
          PYTHONHASHSEED: 0
      
      - name: Verify Export Created
        run: |
          if [ ! -f "roster_matrix.csv" ]; then
            echo "❌ Error: roster_matrix.csv not created"
            exit 1
          fi

          rows=$(wc -l < roster_matrix.csv)
          if [ "$rows" -lt 2 ]; then
            echo "❌ Error: roster_matrix.csv is empty (only $rows rows)"
            exit 1
          fi

          echo "✅ roster_matrix.csv created with $rows rows"

      - name: Parse Results (Smoke Test)
        run: |
          # Simple sanity check: contains FTE/PT drivers
          if grep -q "FTE" roster_matrix.csv && \
             grep -q ";" roster_matrix.csv; then
            echo "✅ Export format looks valid"
          else
            echo "❌ Export format invalid"
            exit 1
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-gate-results-${{ github.sha }}
          path: |
            roster_matrix.csv
            artifacts/
          retention-days: 7
      
  pytest-suite:
    name: Test Suite (xfail known issues)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend_py/requirements.txt
      
      - name: Run pytest (Stability Gate - BLOCKING)
        run: |
          cd backend_py
          pytest \
            api/tests \
            tests \
            packs/roster/tests \
            packs/roster/engine/tests \
            --tb=short \
            -v \
            -x \
            --ignore=packs/roster/tests/test_simulation_no_side_effects.py \
            --ignore=packs/roster/tests/test_lock_recheck_violations.py \
            --ignore=packs/roster/tests/test_master_orchestrator.py \
            --ignore=packs/roster/tests/test_validation_engine.py \
            --ignore=packs/roster/tests/test_draft_mutations.py \
            --ignore=packs/roster/tests/test_slot_state_invariants.py \
            --ignore=packs/roster/tests/test_weekly_summary.py
        env:
          PYTHONHASHSEED: 0

  frontend-build:
    name: Frontend Build (TypeScript + Next.js)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend_v5/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend_v5
          npm ci

      - name: TypeScript check
        run: |
          cd frontend_v5
          npx tsc --noEmit

      - name: Next.js build
        run: |
          cd frontend_v5
          npm run build
