name: CI - PR & Push Gate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger for testing

env:
  PYTHON_VERSION: "3.12"
  PYTHONHASHSEED: "0"

jobs:
  quality-gate:
    name: Quality Gate (Fast)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend_py/requirements.txt
      
      - name: Prepare test fixture
        run: |
          cp backend_py/tests/fixtures/forecast_ci_test.csv "forecast input.csv"
      
      - name: Verify fixture is used (not production data)
        run: |
          lines=$(wc -l < "forecast input.csv")
          echo "Forecast input: $lines lines"
          
          # CI fixture should be ~100 lines, production is ~300+
          if [ "$lines" -gt 150 ]; then
            echo "⚠️ WARNING: Forecast looks like production data (${lines} lines)"
            echo "Expected: CI fixture (~100 lines)"
            exit 1
          fi
          
          echo "✅ Using CI test fixture (${lines} lines)"
      
      - name: Run Quality Gate (Seed 42, 60s budget)
        run: |
          python backend_py/export_roster_matrix.py \
            --time-budget 60 \
            --seed 42
        env:
          PYTHONHASHSEED: 0
      
      - name: Verify Export Created
        run: |
          if [ ! -f "backend_py/roster_matrix.csv" ]; then
            echo "❌ Error: roster_matrix.csv not created"
            exit 1
          fi
          
          rows=$(wc -l < backend_py/roster_matrix.csv)
          if [ "$rows" -lt 2 ]; then
            echo "❌ Error: roster_matrix.csv is empty (only $rows rows)"
            exit 1
          fi
          
          echo "✅ roster_matrix.csv created with $rows rows"
      
      - name: Parse Results (Smoke Test)
        run: |
          # Simple sanity check: contains FTE/PT drivers
          if grep -q "FTE" backend_py/roster_matrix.csv && \
             grep -q ";" backend_py/roster_matrix.csv; then
            echo "✅ Export format looks valid"
          else
            echo "❌ Export format invalid"
            exit 1
          fi
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-gate-results-${{ github.sha }}
          path: |
            backend_py/roster_matrix.csv
            artifacts/
          retention-days: 7
      
  pytest-suite:
    name: Test Suite (xfail known issues)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend_py/requirements.txt
      
      - name: Run pytest
        run: |
          cd backend_py
          pytest \
            --tb=short \
            -v \
            || echo "⚠️ Some tests failed (non-blocking for now)"
        continue-on-error: true
        env:
          PYTHONHASHSEED: 0
