# GUARDIAN - SOLVEREIGN Context Router

> **Purpose**: Deterministic routing to context branches based on task type
> **Version**: 1.0.0
> **Last Updated**: 2026-01-07

---

## FIRST ACTION: Read 00-current-state.md

Before ANY action, read `.claude/context/00-current-state.md` (generated by bootstrap).

Check:
- Active S0/S1 incidents? → **STOP-THE-LINE** → `stability/incident-triage.md`
- Health degraded? → `stability/health-checks.md`
- Performance baseline unknown? → `performance/capacity-planning.md`
- All green? → Use routing table below

---

## SEVERITY DEFINITIONS (Matches Kernel)

| Level | Name | Effect | Default Route |
|-------|------|--------|---------------|
| **S0** | CRITICAL | Security/Data Leak Risk. **HARD STOP**: Block all requests. | `security/rls-enforcement.md` |
| **S1** | HIGH | Integrity/Evidence Risk. **Block writes**: Lock/repair blocked. | `stability/incident-triage.md` |
| **S2** | MEDIUM | Operational Degraded. Read-only allowed, fallback policy. | `stability/health-checks.md` |
| **S3** | LOW | UX/Non-critical. Log only, no operational block. | (context-dependent) |

**STOP-THE-LINE**: S0 or S1 active → ALL other work blocked until resolved.

---

## ROUTING TABLE (DETERMINISTIC)

### HARD OVERRIDE: Security ALWAYS Wins

If ANY security keyword matches → `security/` (even with incident/down keywords)

**Security Keywords**: `RLS`, `leak`, `auth`, `cross-tenant`, `vuln`, `token`, `HMAC`, `replay`, `injection`, `XSS`

**Example**: "System is down and there's a tenant leak" → `security/` (NOT stability)

---

### Standard Priority (when no security keywords)

| Priority | Condition | Branch | First Action |
|----------|-----------|--------|--------------|
| 1 | Active S0/S1 incident in `active-incidents.json` | `stability/` | Read `incident-triage.md` |
| 2 | Keywords: `incident`, `broken`, `down`, `error`, `crash`, `exception` | `stability/` | Read `incident-triage.md` |
| 3 | Keywords: `timeout`, `RAM`, `freeze`, `slow`, `memory`, `cap`, `pool` | `performance/` | Read `timeout-playbook.md` |
| 4 | Keywords: `test`, `audit`, `proof`, `determinism`, `golden`, `hash` | `quality/` | Read `determinism-proof.md` |
| 5 | Keywords: `migration`, `schema`, `kernel`, `pack`, `boundary` | `architecture/` | Read `pack-contracts.md` |
| 6 | Keywords: `deploy`, `rollback`, `tenant`, `onboard`, `release` | `operations/` | Read `deployment-checklist.md` |
| 7 | Ambiguous / unclear | `stability/` | Read `incident-triage.md` (default safe) |

**Priority Rule**: Security override first, then lowest number wins.

---

## HARD RULES

### 1. EVIDENCE-FIRST
Before making ANY changes during an incident:
- Secure Run-ID
- Capture logs
- Save artifacts
- Document current state

### 2. STOP-THE-LINE
S1/S2 incidents block ALL other work until:
- Root cause identified
- Mitigation applied
- Health probes pass

### 3. DEFAULT ROUTES
If context is ambiguous:
- `stability/` for anything that sounds like a problem
- `performance/` for anything slow/frozen
- `security/` for anything auth/data related
- Ask user ONLY if still unclear after checking branch README

### 4. NO GUESSING FOR INCIDENTS
Default to `stability/incident-triage.md` if:
- User mentions anything negative about system state
- Health check shows degraded
- Any S1/S2 severity indicators

---

## CONTEXT TREE STRUCTURE

```
.claude/
├── GUARDIAN.md                    ← YOU ARE HERE
├── context/
│   ├── 00-current-state.md        ← Generated by bootstrap (volatile, gitignored)
│   ├── security/                  ← Auth, RLS, vulnerabilities
│   ├── performance/               ← Timeouts, memory, capacity
│   ├── stability/                 ← Incidents, health, escalations
│   ├── quality/                   ← Tests, audits, determinism
│   ├── architecture/              ← Kernel/Pack, migrations, contracts
│   └── operations/                ← Deploy, rollback, onboarding
├── state/
│   ├── examples/                  ← Git-tracked (reference data)
│   │   ├── last-known-good.json
│   │   ├── active-incidents.json
│   │   ├── tenant-status.json
│   │   └── drift-baselines.json
│   └── runtime/                   ← Volatile (gitignored, bootstrap-generated)
│       └── (generated files)
├── telemetry/                     ← Volatile (gitignored)
│   ├── health_latest.json
│   └── perf_latest.json
└── schemas/                       ← JSON Schema validation
    ├── incident.schema.json
    ├── last-known-good.schema.json
    ├── tenant-status.schema.json
    ├── drift-baselines.schema.json
    ├── run-manifest.schema.json   ← Run context (Run-ID, hashes)
    ├── audit-event.schema.json    ← Security events
    └── drift-report.schema.json   ← Matrix/OSRM drift
```

---

## STATE FILE LOCATIONS

### Examples (Git-tracked, reference data)
| File | Purpose |
|------|---------|
| `state/examples/last-known-good.json` | Reference format for last healthy state |
| `state/examples/active-incidents.json` | Reference format for incidents |
| `state/examples/tenant-status.json` | Reference format for tenant health |
| `state/examples/drift-baselines.json` | Reference format for KPI baselines |

### Runtime (Volatile, gitignored, bootstrap-generated)
| File | Purpose | Update Frequency |
|------|---------|------------------|
| `state/runtime/current-state.json` | Live system state | Bootstrap |
| `state/runtime/active-incidents.json` | Currently open incidents | On incident create/resolve |
| `state/runtime/tenant-status.json` | Live tenant RLS/auth status | On smoke test run |
| `state/runtime/drift-baselines.json` | Current performance baselines | Nightly |

---

## BOOTSTRAP COMMAND

Generate current state before starting work:

```bash
python backend_py/guardian_bootstrap.py
```

This creates:
- `.claude/context/00-current-state.md` (routing decision)
- `.claude/telemetry/health_latest.json`
- `.claude/telemetry/perf_latest.json`

---

## QUICK REFERENCE

**User says "it's broken"** → `stability/incident-triage.md`
**User says "it's slow"** → `performance/timeout-playbook.md`
**User says "security issue"** → `security/rls-enforcement.md`
**User says "run tests"** → `quality/determinism-proof.md`
**User says "migration"** → `architecture/migration-rules.md`
**User says "deploy"** → `operations/deployment-checklist.md`

---

## TOOLS (NOT CONTEXT)

Former "Skills 113-116" are now CLI tools in `backend_py/tools/`:
- `tools/audit_report/` - Enterprise audit pack generation
- `tools/impact_preview/` - Change impact analysis
- `tools/golden_datasets/` - Test fixture management
- `tools/kpi_drift/` - KPI drift detection

These are invoked explicitly, not loaded as context.

---

## PILOT SECURITY DOCUMENTATION

**Wien Pilot (46 vehicles)** - Security audit chain:

| Document | Purpose | Path |
|----------|---------|------|
| **Security Gate** | 3 STOP conditions, proof snippets, rollback plan | [SECURITY_AUDIT_PILOT_CHAIN.md](../SECURITY_AUDIT_PILOT_CHAIN.md) |
| **BFF Audit** | Platform auth, CSRF, cookies, session | [frontend_v5/SECURITY_AUDIT_PLATFORM_AUTH.md](../frontend_v5/SECURITY_AUDIT_PLATFORM_AUTH.md) |
| **Backend Audit** | HMAC, RLS, replay protection, idempotency | [backend_py/SECURITY_AUDIT_BACKEND.md](../backend_py/SECURITY_AUDIT_BACKEND.md) |
| **Operations Runbook** | Dispatcher/Approver/Ops procedures | [RUNBOOK_WIEN_PILOT.md](../RUNBOOK_WIEN_PILOT.md) |

**HARD RULE**: Before any pilot deployment, verify:
1. All 3 STOP conditions have monitoring configured
2. Rollback commands are tested
3. On-call SRE assigned

---

## BLINDSPOT PREVENTION

### 1. State-Commit-Falle
- `state/runtime/*` → NEVER committed (gitignored)
- `state/examples/*` → Committed (reference data)

### 2. Non-deterministic Indexing
- Routing table uses fixed priority order (1-7)
- No "latest file first" or random ordering

### 3. Leak Prevention
- No secrets/tokens/cookies in artifacts
- Only references/hashes/policy names
- Bootstrap uses REDACTED for sensitive env vars
