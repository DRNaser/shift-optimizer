{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://solvereign.com/schemas/state-policies.json",
  "version": "1.0.0",
  "description": "State management policies for Guardian Context Tree",
  "directories": {
    "state/examples/": {
      "git_tracked": true,
      "purpose": "Reference data for development and testing",
      "content_type": "Baseline configurations, example incidents, template data",
      "secrets_policy": "MUST NOT contain secrets - review before commit",
      "retention": "permanent",
      "files": {
        "last-known-good.json": {
          "schema": "schemas/last-known-good.schema.json",
          "description": "Example LKG state for reference",
          "source": "Manual or copied from runtime after successful deploy"
        },
        "active-incidents.json": {
          "schema": "schemas/incident.schema.json",
          "description": "Example incidents for testing routing",
          "source": "Manual"
        },
        "tenant-status.json": {
          "schema": "schemas/tenant-status.schema.json",
          "description": "Example tenant configurations",
          "source": "Manual or sanitized from production"
        },
        "drift-baselines.json": {
          "schema": "schemas/drift-baselines.schema.json",
          "description": "Performance baselines for KPI drift detection",
          "source": "Updated by nightly baseline job"
        }
      }
    },
    "state/runtime/": {
      "git_tracked": false,
      "purpose": "Volatile state generated by bootstrap, never committed",
      "content_type": "Current system state, live health data, computed routing",
      "secrets_policy": "AUTOMATICALLY REDACTED by guardian_bootstrap.py",
      "retention": "session",
      "max_size_bytes": 1048576,
      "files": {
        "platform-state.json": {
          "description": "System info, git state, env summary (redacted)",
          "generated_by": "guardian_bootstrap.py",
          "redaction": "Recursive secret pattern matching"
        },
        "security-state.json": {
          "description": "Tenant auth modes, RLS status, security smoke results",
          "generated_by": "guardian_bootstrap.py",
          "redaction": "Key-based + value-based patterns"
        },
        "ops-state.json": {
          "description": "Health status, incident count, routing hint",
          "generated_by": "guardian_bootstrap.py",
          "redaction": "Minimal - mostly computed values"
        },
        "current-state.json": {
          "description": "Combined state for backward compatibility",
          "generated_by": "guardian_bootstrap.py",
          "deprecated": true
        }
      }
    },
    "telemetry/": {
      "git_tracked": false,
      "purpose": "Operational telemetry, health snapshots, performance metrics",
      "content_type": "Time-series data, health probes, solve metrics",
      "secrets_policy": "Should not contain secrets, but redaction applied",
      "retention": "limited",
      "max_files": 20,
      "cleanup_policy": "Keep N most recent, delete older",
      "files": {
        "health_latest.json": {
          "description": "Latest health probe result with routing decision",
          "generated_by": "guardian_bootstrap.py",
          "ttl_seconds": null
        },
        "perf_latest.json": {
          "description": "Performance baselines and latest solve metrics",
          "generated_by": "guardian_bootstrap.py",
          "ttl_seconds": null
        },
        "solve_latest.json": {
          "description": "Latest solver run metrics (created by solver)",
          "generated_by": "solver_wrapper.py",
          "ttl_seconds": 86400
        }
      }
    },
    "context/": {
      "git_tracked": true,
      "purpose": "Documentation for context routing",
      "content_type": "Markdown files with operational runbooks",
      "secrets_policy": "MUST NOT contain secrets",
      "retention": "permanent",
      "exception": {
        "00-current-state.md": {
          "git_tracked": false,
          "purpose": "Generated volatile state summary",
          "generated_by": "guardian_bootstrap.py"
        }
      }
    }
  },
  "secret_handling": {
    "redaction_levels": {
      "key_pattern": {
        "description": "Key name matches secret pattern (secret, password, key, token, etc.)",
        "output": "[REDACTED:key_pattern]"
      },
      "value_pattern": {
        "description": "Value matches secret pattern (AWS key, JWT, Bearer token, etc.)",
        "output": "[REDACTED:pattern_match]"
      },
      "truncation": {
        "description": "Value exceeds MAX_ENV_VALUE_LENGTH (200 chars)",
        "output": "[TRUNCATED:Nchars]"
      },
      "default": {
        "description": "Non-whitelisted env var",
        "output": "[REDACTED]"
      }
    },
    "allowed_env_keys": [
      "NODE_ENV",
      "PYTHON_ENV",
      "APP_ENV",
      "DATABASE_HOST",
      "OSRM_HOST",
      "REDIS_HOST",
      "LOG_LEVEL",
      "DEBUG",
      "SOLVEREIGN_PLATFORM_WRITES_DISABLED"
    ],
    "secret_value_patterns": [
      "AKIA[0-9A-Z]{16}",
      "Bearer\\s+[A-Za-z0-9\\-_\\.]+",
      "eyJ[A-Za-z0-9\\-_]+\\.eyJ[A-Za-z0-9\\-_]+\\.[A-Za-z0-9\\-_]+",
      "sk-[A-Za-z0-9]{20,}",
      "sk-ant-[A-Za-z0-9\\-]+",
      "ghp_[A-Za-z0-9]{36}",
      "gho_[A-Za-z0-9]{36}"
    ]
  },
  "validation_rules": {
    "on_bootstrap": {
      "validate_examples": true,
      "exit_on_failure": true,
      "exit_code": 1
    },
    "on_commit": {
      "check_runtime_not_staged": true,
      "check_telemetry_not_staged": true,
      "check_secrets_in_examples": true
    }
  }
}
